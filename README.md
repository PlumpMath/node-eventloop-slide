# Node.js イベントループを調べてみた
東京 Node 学園祭用スライド。


## 案
### 冒頭
調べることになったきっかけについて書く。

* JavaScript の非同期について説明している時に、イベントループも一緒に説明してる
* でも、自分が考えているイベントループが正しいかどうか自信がなかった
* いくつかあやしいところがある
  - Linux には非同期システムコールがないらしい
  - 調べてみても (日本語の) 割と正確な資料が見つけられなかった
  - setImmediate とか、名前的に他より優先権がありそう

調べて見るにしても、ブラウザーのソースコードを追いかけるのは大変そうなので、Node.js のソースコードを読んでみた。

途中読み間違えてるところがあるかもしれないので、指摘貰えるととても助かります。


### 結果
余計なことを話をしてもしょうがないので、調べた結果の結論をいろいろと書いていく。


#### 公式ドキュメント
C/C++ 言語のソースコードを読むのは久々で、社長にも手伝ってもらって苦労して読み進めたけど、関数名を頼りにググった末に発見したのが公式ドキュメント。これだけで読めば大体良かった気がする。私の時間を返せ...

* イベントキューは役割でフェーズに分かれてて、結構複雑
  - 結構予想外
* 処理が終わってから非同期関数がイベントループに登録されるわけでないぽい

| 名前 | 役割
| ---- | ----
| timers | `setTimeout()` と `setInterval()` の実行
| I/O callbacks | TCP エラーなどの例外と `setImmediate()`
| idle, prepare | 内部使用
| poll | メインの処理?
| check | `setImmediate()`
| close callbacks | ソケットが閉じた時とか

調べないといけないことがけっこういっぱいある。

* timers と poll のどっちで `setTimeout` が実行されるのか?
  - poll の方はコントロールだけっぽい


#### SoftwareDesign 2016 年 10 月号
http://gihyo.jp/magazine/SD/archive/2016/201610

https://twitter.com/yosuke_furukawa/status/778469675252404225

#### Event Loop, yay
https://drive.google.com/file/d/0B1ENiZwmJ_J2a09DUmZROV9oSGc/view


#### ソースコード構成
ソースコードの構成だけでなくて、Node.js の大まかな構成も説明?

| 場所 | 役割
| ---- | ----
| src | Node.js のソースコード (C++)
| lib | Node.js オブジェクト (JavaScript)
| deps/ | 依存ライブラリ
| deps/uv | libuv
| deps/uv/src/queue.h | キューマクロ
| deps/uv/unix | libuv Unix 用ソースコード
| deps/uv/src/unix/core.c | libuv イベントループ等
| deps/uv/win | libuv Windows 用ソースコード
| deps/v8 | v8
| deps/... | 他


#### queue.h
libuv が提供している汎用キューマクロ。心底読みにくかった。

* キューの構造について

#### 役割
ソースコード構成とまとめたほうがいいかも。

* Node.js は libuv のイベントループを主に使っている
* V8 のイベントループも動いているけど使っているかは調べていない
* Timer 関数は V8 じゃなくて Node.js + libuv


#### Timer の挙動
こういうのをソースコードを元に解説できたらかっこいいかも。

* `setInterval()` はハンドラーで重複したコールバック関数が登録されることはない
* イベントキューに溜まっているコールバック関数の呼び出し順は登録順ではなく、発火順っぽい
- このあたりソースコードを読んで裏を取る


### 最後
最後に

* printf デバッグとコードリーディングでざっと調べただけなので、間違いがあるかも
  - デバッガ使えるようにならないと結構厳しいね
* 英語苦手なので読み間違いがあるかも
* 調べたのは Linux の実装なので、Windows や他の OS はまた違うはず
* 調べるにあたり libuv のソースコードを中心に読むことになったので、Node.js 限定のお話になった。今回調べたイベントループの構造が JavaScript 一般とは言えない
  - JS エンジンの話なので Node.js から辿って V8 のコードを読むつもりが何故か libuv を読んでた
  - 実装がたくさんあるからどうしたらいいんだろう?
  - イベントループの構造まで ECMA-232 とかで定義されているのかな?
